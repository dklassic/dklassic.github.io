<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>08. AI Behavior Revamp and Procedural Animation | Chosen Concept - DK Liao Games</title>

    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">    
<meta name="viewport" content="width=device-width,minimum-scale=1">
<meta name="description" content="AI Behavior Revamp üîóMy old solution relies on Unity&rsquo;s NavMesh and NavMeshAgent. This becomes a chore to me later on because:
As my levels becomes more dynamic, managing NavMesh becomes a tedious work NavMeshAgent can reliably move towards the destination, but also costs too much to request frequently My gameplay is very fast-paced, so I&rsquo;d like my enemies to react to player action as fast as possible So I decided to move to a custom solution that is basically about picking a preferred direction and move forward.">
<meta name="generator" content="Hugo 0.111.3">


  <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">


<link rel="stylesheet" href="/css/style.css">



<link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />




  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css" integrity="sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js" integrity="sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js" integrity="sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script>




  </head>

  <body>
    <nav class="navigation">
	
		<a href="/"> <span class="arrow">‚Üê</span>Home</a>
	
	<a href="/tags">Tags</a>
	<a href="/game-list">Games</a>
	<a href="/about">About</a>

	

	
</nav>


    <main class="main">
      

<section id="single">
    <h1 class="title">08. AI Behavior Revamp and Procedural Animation</h1>

    
          <div class="tip">
        <time datetime="2022-10-20 10:00:25 &#43;0800 CST">Oct 20, 2022</time>
        <span class="split">
          ¬∑
        </span>
        <span>
          730 words
        </span>
        <span class="split">
          ¬∑
        </span>
        <span>
          4 minute read
        </span>
    </div>
    
        <div class="tags">
            
                <a href="http://blog.chosenconcept.dev/tags/autopanic">Autopanic</a>
            
        </div>
    
    

    
        
  
    <aside class="toc">
      <details>
          <summary>Table of Contents
          </summary>
          <div>
              <nav id="TableOfContents">
  <ul>
    <li><a href="#ai-behavior-revamp">AI Behavior Revamp</a>
      <ul>
        <li><a href="#movement-determination">Movement Determination</a></li>
        <li><a href="#attack-pattern">Attack Pattern</a></li>
      </ul>
    </li>
    <li><a href="#procedural-animation">Procedural Animation</a>
      <ul>
        <li><a href="#ui-animation">UI Animation</a></li>
        <li><a href="#generic-procedural-animation">Generic Procedural Animation</a>
          <ul>
            <li><a href="#hit-reaction">Hit Reaction</a></li>
            <li><a href="#weapon-recoil">Weapon Recoil</a></li>
          </ul>
        </li>
        <li><a href="#procedural-movement-animation">Procedural Movement Animation</a></li>
      </ul>
    </li>
  </ul>
</nav>
          </div>
      </details>
    </aside>
  


    


    <div class="content">
      <h1 id="ai-behavior-revamp">AI Behavior Revamp <a href="#ai-behavior-revamp" class="anchor">üîó</a></h1><p>My old solution relies on Unity&rsquo;s NavMesh and NavMeshAgent. This becomes a chore to me later on because:</p>
<ul>
<li>As my levels becomes more dynamic, managing NavMesh becomes a tedious work
NavMeshAgent can reliably move towards the destination, but also costs too much to request frequently</li>
<li>My gameplay is very fast-paced, so I&rsquo;d like my enemies to react to player action as fast as possible</li>
</ul>
<p>So I decided to move to a custom solution that is basically about picking a preferred direction and move forward.</p>
<h2 id="movement-determination">Movement Determination <a href="#movement-determination" class="anchor">üîó</a></h2><p>Generally a level may look something like this:</p>
<p><p class="markdown-image">
  
  <img src="/images/posts/game-design/0004/1.jpg" alt="obstacles"  / class="medium-zoom-image">
</p></p>
<p>For each calculation, the agent will check the following things:</p>
<ul>
<li>Obstacle around the agent (e.g. other agents, traps, and decors)</li>
<li>Distance and direction towards a preferred location (e.g. movement destination and target agent)</li>
</ul>
<p>So it&rsquo;s all about avoid bumping into obstacles and wanting to have a certain distance between certain target. Which looked like this:</p>
<p><p class="markdown-image">
  
  <img src="/images/posts/game-design/0004/3.jpg" alt="scoring"  / class="medium-zoom-image">
</p></p>
<p>Then I added some physical constraints to make the agent move more naturally, such as:</p>
<ul>
<li>Having acceleration/deceleration speed</li>
<li>Having max speed</li>
<li>Will decelerate if the preferred direction is too different from current direction</li>
<li>Have a max rotation speed</li>
</ul>
<p>I could&rsquo;ve gone further and have rotation acceleration/deceleration, but I find it somewhat hard to balance around the numbers, so I&rsquo;ve decided to omit it for now.</p>
<p>So far so good:</p>
<p><p class="markdown-image">
  
  <img src="/images/posts/game-design/0004/4.gif" alt="movement"  / class="medium-zoom-image">
</p>
<p class="markdown-image">
  
  <img src="/images/posts/autopanic-devlog/0008/1.gif" alt="enemy roaming"  / class="medium-zoom-image">
</p></p>
<p>This approach also helps me make some actions more dynamic, such as &ldquo;Strategic Dash&rdquo; and &ldquo;Emergency Evade&rdquo;, for these action can now be used with understandings of the environment instead of a fixed direction and stuffs.</p>
<p>I&rsquo;ve then spend some time optimizing raycast with multithread but nothing fancy.</p>
<h2 id="attack-pattern">Attack Pattern <a href="#attack-pattern" class="anchor">üîó</a></h2><p>I decided to move towards the idea of an attack pattern. To ensure the combat won&rsquo;t become raw skill-based chaos, but a more manageable situation to be learned and resolved by the players.</p>
<p>So I constructed a hefty list of actions available, just to name a few:</p>
<p><p class="markdown-image">
  
  <img src="/images/posts/autopanic-devlog/0008/3.png" alt="commands"  / class="medium-zoom-image">
</p>
<p class="markdown-image">
  
  <img src="/images/posts/autopanic-devlog/0008/2.png" alt="enemy pattern"  / class="medium-zoom-image">
</p></p>
<p>And now instead of making multitude of enemy prefabs, I now have one enemy prefab that will instantiate with a EnemySetting scriptable object, which makes modification a lot easier.</p>
<p><p class="markdown-image">
  
  <img src="/images/posts/autopanic-devlog/0008/4.png" alt="enemy setting"  / class="medium-zoom-image">
</p></p>
<p>Now with enemy behavior revamped, time to add in procedural animation.</p>
<h1 id="procedural-animation">Procedural Animation <a href="#procedural-animation" class="anchor">üîó</a></h1><p>Procedural Animation in my game is a big topic, because basically every single changing element was procedural, i.e. code driven.</p>
<p>I know early on that I&rsquo;m not going to be doing keyframes at all. Not only because I&rsquo;m just but one guy, also that I&rsquo;ve watched the famous talk from David Rosen about procedural animation in Overgrowth and was convinced that procedural animation can be used to achieve suitably high quality animation with way less effort.</p>
<h2 id="ui-animation">UI Animation <a href="#ui-animation" class="anchor">üîó</a></h2><p>Not much to talk about here due to my simple UI setup, but I do have several glitch effect setup for the windows, which is driven by something like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>switch (CurrentTransition)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    case WindowTransition.Noise:
</span></span><span style="display:flex;"><span>        maskIndex[i, j] = UnityEngine.Random.Range(0, TextUtility.FadeIn.Length - 1);
</span></span><span style="display:flex;"><span>        break;
</span></span><span style="display:flex;"><span>    case WindowTransition.Glitch:
</span></span><span style="display:flex;"><span>        if (UnityEngine.Random.value &gt; 0.5f)
</span></span><span style="display:flex;"><span>            maskIndex[i, j] += Mathf.FloorToInt(Time.unscaledDeltaTime / maskAnimationStep);
</span></span><span style="display:flex;"><span>        break;
</span></span><span style="display:flex;"><span>    case WindowTransition.DamageGlitch:
</span></span><span style="display:flex;"><span>        if (UnityEngine.Random.value &gt; 0.5f)
</span></span><span style="display:flex;"><span>            maskIndex[i, j] += Mathf.FloorToInt(Time.unscaledDeltaTime / maskAnimationStep);
</span></span><span style="display:flex;"><span>        break;
</span></span><span style="display:flex;"><span>    case WindowTransition.Random:
</span></span><span style="display:flex;"><span>        if (UnityEngine.Random.value &gt; 0.25f)
</span></span><span style="display:flex;"><span>            maskIndex[i, j] += Mathf.FloorToInt(UnityEngine.Random.Range(1, TextUtility.FadeIn.Length - 1) * Time.unscaledDeltaTime / maskAnimationStep);
</span></span><span style="display:flex;"><span>        break;
</span></span><span style="display:flex;"><span>    default:
</span></span><span style="display:flex;"><span>        maskIndex[i, j] += Mathf.FloorToInt(Time.unscaledDeltaTime / maskAnimationStep);
</span></span><span style="display:flex;"><span>        break;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Some demonstration:</p>
<p><p class="markdown-image">
  
  <img src="/images/posts/autopanic-devlog/0008/5.gif" alt="ui animation"  / class="medium-zoom-image">
</p></p>
<h2 id="generic-procedural-animation">Generic Procedural Animation <a href="#generic-procedural-animation" class="anchor">üîó</a></h2><p>This part is a bit more fun. Mostly done with DOTween because DOTween is just great. Some examples:</p>
<h3 id="hit-reaction">Hit Reaction <a href="#hit-reaction" class="anchor">üîó</a></h3><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>icon.DOPunchRotation(damageForce / unitSize, <span style="color:#666">0.5f</span>, <span style="color:#666">10</span>, <span style="color:#666">0</span>)
</span></span></code></pre></div><p><p class="markdown-image">
  
  <img src="/images/posts/autopanic-devlog/0008/6.gif" alt="hit reaction"  / class="medium-zoom-image">
</p></p>
<h3 id="weapon-recoil">Weapon Recoil <a href="#weapon-recoil" class="anchor">üîó</a></h3><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>recoilTarget.DOPunchPosition(recoilForce / unitSize, recoilDuration, <span style="color:#666">1</span>)
</span></span></code></pre></div><p><p class="markdown-image">
  
  <img src="/images/posts/autopanic-devlog/0008/7.gif" alt="rifle recoil"  / class="medium-zoom-image">
</p>
<p class="markdown-image">
  
  <img src="/images/posts/autopanic-devlog/0008/8.gif" alt="shotgun recoil"  / class="medium-zoom-image">
</p></p>
<p>Simple, quick to make, and can include the consideration of physicality quite easily.</p>
<h2 id="procedural-movement-animation">Procedural Movement Animation <a href="#procedural-movement-animation" class="anchor">üîó</a></h2><p>Now comes the fun part, though maybe not much to be explained.</p>
<p>I find that making procedural movement animation is basically programming the process of how the real world counterpart would move:</p>
<ul>
<li>If leg is too far away, move</li>
<li>If moving, lean</li>
<li>Move faster if displacement is large</li>
</ul>
<p>Which is as rudimentary as it can be, but this also makes it hard to find resources to follow. I ended up learning more about procedural animation by looking at <a href="https://twitter.com/Jakob_Wahlberg" target="_blank" rel="noopener">Jakob Wahlberg</a>&rsquo;s tweets.</p>
<p>Since I revamped enemy behavior, my AI now have some proper physicality in its movement. So as long as my procedural movement animation can automatically accommodate the displacement of the unit, the result will always be great:</p>
<p><p class="markdown-image">
  
  <img src="/images/posts/game-design/0005/8.gif" alt="All movements"  / class="medium-zoom-image">
</p></p>
<p>And by extension, it also works on player controlled character:</p>
<p><p class="markdown-image">
  
  <img src="/images/posts/autopanic-devlog/0008/9.gif" alt="procedural animation"  / class="medium-zoom-image">
</p></p>
<p>So with procedural animation in place, my game finally looks a lot more complete.</p>

    </div>

    
    
  <div id="comment">
    
    
    <script src="https://utteranc.es/client.js"
        repo="dklassic/comment-utterances"
        issue-term="pathname"
        label="comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>

  </div>


</section>


    </main>
    
    <footer id="footer">
    
        <div id="social">


    <a class="symbol" href="https://www.twitter.com/randomdevdk" rel="me" target="_blank">
        
        <svg fill="#bbbbbb" width="28" height="28" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="438.536px" height="438.536px" viewBox="0 0 438.536 438.536" style="enable-background:new 0 0 438.536 438.536;"
	 xml:space="preserve">
<g>
	<path d="M414.41,24.123C398.333,8.042,378.963,0,356.315,0H82.228C59.58,0,40.21,8.042,24.126,24.123
		C8.045,40.207,0.003,59.576,0.003,82.225v274.084c0,22.647,8.042,42.018,24.123,58.102c16.084,16.084,35.454,24.126,58.102,24.126
		h274.084c22.648,0,42.018-8.042,58.095-24.126c16.084-16.084,24.126-35.454,24.126-58.102V82.225
		C438.532,59.576,430.49,40.204,414.41,24.123z M335.471,168.735c0.191,1.713,0.288,4.278,0.288,7.71
		c0,15.989-2.334,32.025-6.995,48.104c-4.661,16.087-11.8,31.504-21.416,46.254c-9.606,14.749-21.074,27.791-34.396,39.115
		c-13.325,11.32-29.311,20.365-47.968,27.117c-18.648,6.762-38.637,10.143-59.953,10.143c-33.116,0-63.76-8.952-91.931-26.836
		c4.568,0.568,9.329,0.855,14.275,0.855c27.6,0,52.439-8.565,74.519-25.7c-12.941-0.185-24.506-4.179-34.688-11.991
		c-10.185-7.803-17.273-17.699-21.271-29.691c4.947,0.76,8.658,1.137,11.132,1.137c4.187,0,9.042-0.76,14.56-2.279
		c-13.894-2.669-25.598-9.562-35.115-20.697c-9.519-11.136-14.277-23.84-14.277-38.114v-0.571
		c10.085,4.755,19.602,7.229,28.549,7.422c-17.321-11.613-25.981-28.265-25.981-49.963c0-10.66,2.758-20.747,8.278-30.264
		c15.035,18.464,33.311,33.213,54.816,44.252c21.507,11.038,44.54,17.227,69.092,18.558c-0.95-3.616-1.427-8.186-1.427-13.704
		c0-16.562,5.853-30.692,17.56-42.399c11.703-11.706,25.837-17.561,42.394-17.561c17.515,0,32.079,6.283,43.688,18.846
		c13.134-2.474,25.892-7.33,38.26-14.56c-4.757,14.652-13.613,25.788-26.55,33.402c12.368-1.716,23.88-4.95,34.537-9.708
		C357.458,149.793,347.462,160.166,335.471,168.735z"/>
</g>
</svg>

    </a>


</div>

    

    <div class="copyright">
    
       ¬© Copyright 
       2023 
       <span class="split">
        <svg fill="#bbbbbb" width="15" height="15" version="1.1" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15px" height="15px" viewBox="0 0 15 15">
  <path d="M13.91,6.75c-1.17,2.25-4.3,5.31-6.07,6.94c-0.1903,0.1718-0.4797,0.1718-0.67,0C5.39,12.06,2.26,9,1.09,6.75&#xA;&#x9;C-1.48,1.8,5-1.5,7.5,3.45C10-1.5,16.48,1.8,13.91,6.75z"/>
</svg>
       </span>
       DK Liao
    
    </div>

    
      <div class="powerby">
        Powered by <a href='http://www.gohugo.io/'>Hugo</a> Theme By <a href='https://github.com/nodejh/hugo-theme-mini'>nodejh</a>
      </div>
    
</footer>




<script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js" integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
const images = Array.from(document.querySelectorAll("img.medium-zoom-image"));
images.forEach(img => {
  mediumZoom(img, {
    margin: 0,  
    scrollOffset: 40,  
    container: null,  
    template: null  
  });
});
</script>

  </body>
</html>
